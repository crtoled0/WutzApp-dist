function Connect2BarModel(){var e,o=this,a=function(e){koMods.main.openLoading(),wmap.load(koMods.main.config(),function(){koMods.main.closeLoading(),console.log("Google Maps API loaded")})},n=function(o){var a=window.localStorage;device&&(e=device.uuid),e=a.getItem("guid")&&""!==a.getItem("guid")?a.getItem("guid"):gF.generateUUID(),a.setItem("guid",e),console.log("Setted GUID "+e)};o.bars=ko.observableArray([]),o.openGPS=ko.observable(!1),o.pickedBar=ko.observable(),o.canClose=ko.computed(function(){return!!koMods.main.barLoaded()},this),o.checkIfTokenSetted=function(e){if(!localStorage.getItem("tokenCache"))return!1;var a=JSON.parse(localStorage.getItem("tokenCache"));e?a[e]?$("#inputTokenBar input").val(a[e].dayToken):$("#inputTokenBar input").val(""):($("#searchBarInput").val(a.default.barId),o.searchBars(function(){if(!(o.bars().length>0))return!1;o.showBarDetails(o.bars()[0],function(){return $("#inputTokenBar input").val(a.default.dayToken),o.connect2Bar(),!0})}))},o.init=function(){console.log("Init Connect2BarModel ..."),n(),a(),$("#searchBarBody").slideDown(),$("#detailsBarBody").slideUp(),o.checkIfTokenSetted()},o.refresh=function(){$("#searchBarBody").slideDown(),$("#detailsBarBody").slideUp()},o.searchBars=function(e){o.bars([]),o.openGPS(!1);var a=$("#searchBarInput").val();console.log(a),koMods.main.openLoading(),window.wutzAdmin.callService({service:"searchBar/"+a},function(a){if(koMods.main.closeLoading(),console.log(a),o.bars(a),0===a.length){var n={type:"danger",title:locale.trans("msg_bardoesnt_exist_title"),msg:locale.trans("msg_bardoesnt_exist")};koMods.main.displayGetMessage(n)}e&&e()})},o.searchBarsByGPS=function(){o.bars([]),o.openGPS(!0),koMods.main.openLoading(),wmap.getNearByBarsFromGPS("mapHolder",function(e){if(koMods.main.closeLoading(),e.err){var a={type:"danger",title:"",msg:locale.trans(e.err)};koMods.main.displayGetMessage(a),o.openGPS(!1)}else{console.log(e);var n=e;n.lat&&n.lon&&(koMods.main.openLoading(),window.wutzAdmin.callService({service:"getNearByBars/"+n.lat+"/"+n.lon},function(e){koMods.main.closeLoading(),console.log(e),wmap.drawBarMarkers(e,n.gmap,function(e){o.showBarDetails(e)})}))}})},o.showBarDetails=function(e,a){var n=$("#detailsBarBody .barDescMap").parent().parent().width(),t=$("#detailsBarBody .barDescMap").css("height").replace("px","");console.log(n+" -- "+t),koMods.main.openLoading(),window.wutzAdmin.callService({service:"getBar/"+e.id},function(e){koMods.main.closeLoading(),wtzCache.loadBarCachedInfo(e.id,e.idcatalog,e.catVersion),console.log(e),o.pickedBar(e),koMods.main.barLoaded(e);var i=wmap.getStaticMapImgUrl(e.lat,e.lon,n,t);$("#detailsBarBody .barDescMap").html('<img src="'+i+'" />'),koMods.main.fillArtists(),o.checkIfTokenSetted(e.id),a&&a()}),$("#searchBarBody").slideUp(),$("#detailsBarBody").slideDown()},o.justDisplayBarDetails=function(){$("#searchBarBody").slideUp(),$("#detailsBarBody").slideDown()},o.connect2Bar=function(){var e=koMods.main.barLoaded(),o=$("#inputTokenBar input").val(),a={catId:e.idcatalog,token:o};if(""===o)return!1;koMods.main.openLoading(),window.wutzAdmin.callService({service:"checkToken",method:"POST",params:a},function(a){if(koMods.main.closeLoading(),console.log(a),a.tokenOK){e.connected=!0,e.dayToken=o,koMods.main.barLoaded(e),$("#connect2BarContainer").modal("hide");var n=localStorage.getItem("tokenCache");n=n?JSON.parse(n):{default:{}},n.default={barId:e.id,dayToken:o},n[e.id]={dayToken:o},localStorage.setItem("tokenCache",JSON.stringify(n))}else{var t={type:"danger",title:locale.trans("not_connected"),msg:locale.trans("no_connected_msg")};koMods.main.displayGetMessage(t)}})}}